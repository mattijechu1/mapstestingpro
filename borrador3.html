 // Construir el KML a partir de las capas activas
    const kmlContent = <?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
    <name>${escapeXML(activeCoberturaName)}</name>
    ${activeLayer
        .map((feature) => {
            const properties = feature.properties || {};
            const coordinates = feature.geometry?.coordinates || [];
            if (coordinates.length < 2) return ""; // Ignorar geometrías inválidas

            const propsDescription = Object.entries(properties)
                .map(
                    ([key, value]) =>
                        <b>${escapeXML(key)}:</b> ${escapeXML(String(value))}
                )
                .join("<br>");

            return 
    <Placemark>
        <name>${escapeXML(properties.ID || "Sin nombre")}</name>
        <description><![CDATA[${propsDescription}]]></description>
        <Point>
            <coordinates>${coordinates[0]},${coordinates[1]},0</coordinates>
        </Point>
    </Placemark>;
        })
        .join("")}
</Document>
</kml>;

    // Crear el archivo KMZ usando JSZip
    try {
        const zip = new JSZip();
        zip.file("doc.kml", kmlContent); // Guardar el KML como doc.kml dentro del ZIP

        const kmzBlob = await zip.generateAsync({ type: "blob" });

        // Crear un enlace para descargar el KMZ
        const downloadLink = document.createElement("a");
        downloadLink.href = URL.createObjectURL(kmzBlob);
        downloadLink.download = ${activeCoberturaName || "archivo"}.kmz;
        downloadLink.click();
    } catch (error) {
        console.error("Error al generar el archivo KMZ:", error);
        alert("Ocurrió un error al intentar generar el archivo KMZ.");
    }
}

// Función para descargar en formato GeoJSON
function downloadGeoJSON() {
    if (!activeLayer) {
        alert("No hay cobertura activa para descargar.");
        return;
    }

    const geojsonData = {
        type: "FeatureCollection",
        features: activeLayer
    };

    const geojsonBlob = new Blob([JSON.stringify(geojsonData)], { type: "application/geo+json" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(geojsonBlob);
    link.download = ${activeCoberturaName}_.geojson; // Usar el nombre de la cobertura activa
    link.click();
}

//Función para descargar en Excel
function downloadExcel() {
    if (!activeLayer) {
        alert("No hay cobertura activa para descargar.");
        return;
    }

    // Convertir el JSON de la capa activa en un formato adecuado para Excel
    const excelData = activeLayer.map(feature => {
        return feature.properties;  // Obtener solo las propiedades para el Excel
    });

    // Crear una hoja de cálculo de Excel a partir de los datos
    const ws = XLSX.utils.json_to_sheet(excelData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Cobertura");

    // Descargar el archivo Excel
    XLSX.writeFile(wb, ${activeCoberturaName}_.xlsx);
}

// Iniciar con el cargado de temáticas
cargarSelector();
</script>

</body>
</html>
