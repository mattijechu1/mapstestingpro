<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terrazas Providencia</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tokml@0.4.0/tokml.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <style>
        #map { height: 600px; width: 100%; }
        .download-button { margin-top: 10px; display: block; text-align: center; }
        .layer-control { margin-top: 10px; }
    </style>

<style>
    body {
        text-align: center; /* Centra el título */
    }

    h1 {
        text-align: right; /* Asegura que el título esté centrado */
    }

    .download-button {
        display: inline-block; /* Hace que los botones se alineen en línea */
        margin-top: 10px; /* Espacio superior entre los botones */
        text-align: center; /* Centra el texto dentro de los botones */
        padding: 10px 20px; /* Relleno de los botones */
        background-color: #007BFF; /* Color de fondo */
        color: white; /* Color del texto */
        border: none; /* Elimina el borde por defecto */
        border-radius: 5px; /* Bordes redondeados */
        cursor: pointer; /* Aparece como puntero al pasar el mouse */
    }

    .download-button:hover {
        background-color: #0056b3; /* Color de fondo cuando el botón está en hover */
    }

    #map {
        height: 600px;
        width: 100%;
        margin-top: 20px; /* Espacio superior del mapa */
    }
</style>
    
</head>
<body>
    <h1>Terrazas Gastronómicas Providencia</h1>
    <div id="map"></div>
    <button id="kmzButton" class="download-button">Descargar KMZ</button>
    <button id="geojsonButton" class="download-button">Descargar GeoJSON</button>
  <script>
    const map = L.map('map').setView([-33.433333, -70.616667], 14.4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Añadir barra de búsqueda (Control Geocoder)
    const geocoder = L.Control.geocoder({
        defaultMarkGeocode: false
    })
        .on('markgeocode', function(e) {
            const bbox = e.geocode.bbox;
            const poly = L.polygon([
                [bbox.getSouthEast().lat, bbox.getSouthEast().lng],
                [bbox.getNorthEast().lat, bbox.getNorthEast().lng],
                [bbox.getNorthWest().lat, bbox.getNorthWest().lng],
                [bbox.getSouthWest().lat, bbox.getSouthWest().lng]
            ]);
            map.fitBounds(poly.getBounds());
            L.marker(e.geocode.center).addTo(map).bindPopup(e.geocode.name).openPopup();
        })
        .addTo(map);

    // Reubicar la barra de búsqueda arriba del control de zoom
    const geocoderContainer = geocoder.getContainer();
    const zoomControl = document.querySelector('.leaflet-control-zoom');
    zoomControl.parentNode.insertBefore(geocoderContainer, zoomControl);

    const csvUrls = {
        Consolidado: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKCCPRxUwaXo-LXGeUQgZSCzVWZdIYiHNiY51_-u4AG0yODEfv4qd_ErKxQ-6RuQ/pub?gid=599326445&single=true&output=csv',
        Rentas: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKCCPRxUwaXo-LXGeUQgZSCzVWZdIYiHNiY51_-u4AG0yODEfv4qd_ErKxQ-6RuQ/pub?gid=1985883002&single=true&output=csv',
        Fiscalización: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKCCPRxUwaXo-LXGeUQgZSCzVWZdIYiHNiY51_-u4AG0yODEfv4qd_ErKxQ-6RuQ/pub?gid=1998025027&single=true&output=csv',
        Levantamiento_2024: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKCCPRxUwaXo-LXGeUQgZSCzVWZdIYiHNiY51_-u4AG0yODEfv4qd_ErKxQ-6RuQ/pub?gid=1688971863&single=true&output=csv',
        'DIDEL 2023': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKCCPRxUwaXo-LXGeUQgZSCzVWZdIYiHNiY51_-u4AG0yODEfv4qd_ErKxQ-6RuQ/pub?gid=1456784452&single=true&output=csv'
    };


    const layers = {};
    const markers = {};

    function loadCsv(url, groupName) {
        return fetch(url)
            .then(response => response.text())
            .then(data => {
                Papa.parse(data, {
                    header: true,
                    complete: function(results) {
                        const data = results.data;
                        if (!data.length) {
                            console.error(`El archivo CSV de ${groupName} está vacío.`);
                            return;
                        }

                        data.forEach((row, index) => {
                            const lat = parseFloat(row.Y);
                            const lon = parseFloat(row.X);
                            const name = row.LOCAL || `Punto ${index + 1}`;
                            const direccion = row.DIRECCIÓN || 'Dirección no disponible';
                            const local = row.LOCAL || 'No aplica';
                            const foto = row.FOTO || '';

                            if (!isNaN(lat) && !isNaN(lon)) {
                                const popupContent = 
                                    `<strong>${name}</strong><br>
                                    Dirección: ${direccion}<br>
                                    Local: ${local}<br>
                                    Lat: ${lat}, Lon: ${lon}
                                    ${foto ? `<br><img src="${foto}" style="width:200px; height:auto;">` : ''}`;
                                const circle = L.circleMarker([lat, lon], {
                                    color: 'blue',
                                    radius: 4,
                                    fillOpacity: 0.8,
                                    weight: 0
                                }).bindPopup(popupContent);
                                layers[groupName].addLayer(circle);

                                if (!markers[groupName]) {
                                    markers[groupName] = [];
                                }
                                markers[groupName].push({
                                    lat,
                                    lon,
                                    properties: { name, direccion, local, foto }
                                });
                            }
                        });
                    }
                });
            });
    }

    Object.keys(csvUrls).forEach(groupName => {
        layers[groupName] = L.layerGroup();
        loadCsv(csvUrls[groupName], groupName);
    });

    layers['Consolidado'].addTo(map);

    const layerControl = L.control.layers(null, layers).addTo(map);

    function downloadData(type) {
        const activeLayer = Object.keys(layers).find(groupName => map.hasLayer(layers[groupName]));
        if (!activeLayer) {
            alert('Por favor, activa una capa para descargar.');
            return;
        }

        const geojson = {
            type: 'FeatureCollection',
            features: markers[activeLayer].map(marker => ({
                type: 'Feature',
                properties: marker.properties,
                geometry: {
                    type: 'Point',
                    coordinates: [marker.lon, marker.lat]
                }
            }))
        };

        if (type === 'KMZ') {
            const kml = tokml(geojson);
            const zip = new JSZip();
            zip.file('doc.kml', kml);
            zip.generateAsync({ type: 'blob' }).then(content => {
                saveAs(content, `${activeLayer}.kmz`);
            });
        } else if (type === 'GeoJSON') {
            const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/json' });
            saveAs(blob, `${activeLayer}.geojson`);
        }
    }

    document.getElementById('kmzButton').addEventListener('click', () => downloadData('KMZ'));
    document.getElementById('geojsonButton').addEventListener('click', () => downloadData('GeoJSON'));
  </script>
</body>
</html>
