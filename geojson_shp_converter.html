<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoJSON to Shapefile Converter</title>
    <script src="https://unpkg.com/@mapbox/shp-write@latest/shpwrite.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 500px;
            margin: auto;
            text-align: center;
        }
        input, select {
            margin: 10px 0;
            padding: 8px;
        }
        button {
            padding: 10px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GeoJSON to Shapefile Converter</h1>
        <input type="file" id="geojsonFile" accept=".geojson">
        <br>
        <label for="geometryType">Select Geometry Type:</label>
        <select id="geometryType">
            <option value="point">Point</option>
            <option value="multipoint">MultiPoint</option>
            <option value="polygon">Polygon</option>
            <option value="polyline">Polyline</option>
        </select>
        <br>
        <button onclick="convertToShapefile()">Convert to Shapefile</button>
        <p id="status"></p>
    </div>

    <script>
        function convertToShapefile() {
            const fileInput = document.getElementById('geojsonFile');
            const geometryType = document.getElementById('geometryType').value;
            const status = document.getElementById('status');

            if (!fileInput.files.length) {
                status.textContent = 'Please upload a GeoJSON file.';
                return;
            }

            const reader = new FileReader();
            reader.onload = function (event) {
                try {
                    const geojson = JSON.parse(event.target.result);

                    if (geojson.type !== "FeatureCollection" || !Array.isArray(geojson.features)) {
                        throw new Error("Invalid GeoJSON structure. Ensure it is a FeatureCollection.");
                    }

                    const filteredFeatures = geojson.features.filter(feature => 
                        feature.geometry && feature.geometry.type.toLowerCase() === geometryType.toLowerCase()
                    );

                    if (filteredFeatures.length === 0) {
                        throw new Error(`No features of type "${geometryType}" found in the GeoJSON.`);
                    }

                    const filteredGeoJSON = {
                        type: "FeatureCollection",
                        features: filteredFeatures
                    };

                    console.log("Filtered GeoJSON:", filteredGeoJSON);

                    // Convert to Shapefile
                    const zipBlob = shpwrite.zip(filteredGeoJSON);

                    if (!zipBlob) {
                        throw new Error("shpwrite.zip did not return a valid output.");
                    }

                    if (!(zipBlob instanceof Blob)) {
                        console.warn("zipBlob is not a Blob. Debug output:", zipBlob);
                        throw new Error("shpwrite.zip did not return a valid Blob.");
                    }

                    // Create a URL and trigger download
                    const blobUrl = URL.createObjectURL(zipBlob);
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = 'shapefile.zip';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(blobUrl);

                    status.textContent = 'Conversion successful! Download started.';
                } catch (error) {
                    console.error("Error processing GeoJSON:", error);
                    status.textContent = `Error: ${error.message}`;
                }
            };
            reader.readAsText(fileInput.files[0]);
        }
    </script>
</body>
</html>
