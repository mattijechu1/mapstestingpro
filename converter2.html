<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terrazas Providencia</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tokml@0.4.0/tokml.min.js"></script>
    <style>
        #map { height: 600px; width: 100%; }
        .download-button { margin-top: 10px; display: block; text-align: center; }
    </style>
</head>
<body>
    <h1>Terrazas en SECPLA sin registro en RENTAS</h1>
    <div id="map"></div>
    <button id="kmzButton" class="download-button">Convertir a KMZ</button>
    <button id="geojsonButton" class="download-button">Descargar GeoJSON</button>

    <script>
        // Inicializar el mapa
        const map = L.map('map').setView([-33.4489, -70.6693], 12); // Coordenadas iniciales (Santiago)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Almacenar los puntos para exportarlos
        let markers = [];

        // URL del Google Sheet publicado
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQQwiNO1dZQg78m4X9fRe6MTZWioBXd0kJuUEKMZG-wCZx-9ZrhA5de20VDaHr5ySVQ/pubhtml?gid=895076813&single=true';

        // Obtener los datos de la tabla HTML publicada
        fetch(sheetUrl)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const rows = doc.querySelectorAll('table tbody tr');

                rows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    const lat = parseFloat(cells[1]?.textContent.trim()); // Latitud (columna Y)
                    const lon = parseFloat(cells[2]?.textContent.trim()); // Longitud (columna X)
                    const name = cells[0]?.textContent.trim() || `Punto ${index + 1}`; // Columna LOCAL
                    const direccion = cells[3]?.textContent.trim() || 'Dirección no disponible'; // Dirección
                    const foto = cells[4]?.textContent.trim(); // Enlace a la foto (si aplica)

                    // Validar coordenadas
                    if (!isNaN(lat) && !isNaN(lon)) {
                        // Crear contenido del popup
                        let popupContent = `
                            <strong>${name}</strong><br>
                            Dirección: ${direccion}<br>
                            Lat: ${lat}, Lon: ${lon}
                        `;

                        // Si hay una foto válida, agregarla al contenido del popup
                        if (foto) {
                            popupContent += `
                                <br><strong>Foto:</strong><br>
                                <img src="${foto}" alt="Imagen del lugar" style="width: 200px; height: auto;">
                            `;
                        }

                        const marker = L.marker([lat, lon])
                            .addTo(map)
                            .bindPopup(popupContent);

                        markers.push({
                            lat: lat,
                            lon: lon,
                            properties: { name, direccion, foto }
                        });
                    } else {
                        console.warn(`Coordenadas inválidas en fila ${index + 1}`);
                    }
                });
            })
            .catch(error => console.error('Error al obtener los datos de la hoja de Google:', error));

        // Función para convertir a KMZ
        document.getElementById('kmzButton').addEventListener('click', function() {
            const geojson = {
                type: "FeatureCollection",
                features: markers.map(marker => ({
                    type: "Feature",
                    properties: marker.properties,
                    geometry: {
                        type: "Point",
                        coordinates: [marker.lon, marker.lat]
                    }
                }))
            };

            const kml = tokml(geojson);
            const zip = new JSZip();
            zip.file("doc.kml", kml);
            zip.generateAsync({ type: "blob" }).then(function(content) {
                saveAs(content, "terrazas_providencia.kmz");
            });
        });

        // Función para descargar GeoJSON
        document.getElementById('geojsonButton').addEventListener('click', function() {
            const geojson = {
                type: "FeatureCollection",
                features: markers.map(marker => ({
                    type: "Feature",
                    properties: marker.properties,
                    geometry: {
                        type: "Point",
                        coordinates: [marker.lon, marker.lat]
                    }
                }))
            };

            const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: "application/json" });
            saveAs(blob, "terrazas_providencia.geojson");
        });
    </script>
</body>
</html>
