<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terrazas Providencia</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tokml@0.4.0/tokml.min.js"></script>
    <style>
        #map { height: 600px; width: 100%; }
        .download-button { margin-top: 10px; display: block; text-align: center; }
        .layer-control { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Terrazas Gastronómicas Providencia</h1>
    <div id="map"></div>
    <button id="kmzButton" class="download-button">Descargar KMZ</button>
    <button id="geojsonButton" class="download-button">Descargar GeoJSON</button>
    <script>
        // Inicializar el mapa
        const map = L.map('map').setView([-33.433333, -70.616667], 14.4); // Coordenadas iniciales
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        const urls = {
            "Consolidado": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQKCCPRxUwaXo-LXGeUQgZSCzVWZdIYiHNiY51_-u4AG0yODEfv4qd_ErKxQ-6RuQ/pub?gid=599326445&single=true&output=csv",
            "Rentas": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQKCCPRxUwaXo-LXGeUQgZSCzVWZdIYiHNiY51_-u4AG0yODEfv4qd_ErKxQ-6RuQ/pub?gid=1985883002&single=true&output=csv",
            "Fiscalización": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQKCCPRxUwaXo-LXGeUQgZSCzVWZdIYiHNiY51_-u4AG0yODEfv4qd_ErKxQ-6RuQ/pub?gid=1998025027&single=true&output=csv",
            "Levantamiento 2024": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQKCCPRxUwaXo-LXGeUQgZSCzVWZdIYiHNiY51_-u4AG0yODEfv4qd_ErKxQ-6RuQ/pub?gid=1688971863&single=true&output=csv",
            "DIDEL 2023": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQKCCPRxUwaXo-LXGeUQgZSCzVWZdIYiHNiY51_-u4AG0yODEfv4qd_ErKxQ-6RuQ/pub?gid=1456784452&single=true&output=csv"
        };

        const layerGroups = {};
        let activeLayer = null;

        // Función para cargar CSV y agregarlo como capa
        function addLayer(name, url, visible = false) {
            fetch(url)
                .then(response => response.text())
                .then(data => {
                    const markers = [];
                    const layerGroup = L.layerGroup();

                    Papa.parse(data, {
                        header: true,
                        complete: results => {
                            results.data.forEach(row => {
                                const lat = parseFloat(row.Y);
                                const lon = parseFloat(row.X);
                                const name = row.LOCAL || "Sin nombre";
                                const direccion = row.DIRECCIÓN || "Sin dirección";
                                const popupContent = `
                                    <strong>${name}</strong><br>
                                    Dirección: ${direccion}<br>
                                    Lat: ${lat}, Lon: ${lon}
                                `;

                                if (!isNaN(lat) && !isNaN(lon)) {
                                    const marker = L.circleMarker([lat, lon], {
                                        color: 'blue',
                                        radius: 4,
                                        fillOpacity: 0.8
                                    }).bindPopup(popupContent);
                                    marker.addTo(layerGroup);
                                    markers.push({
                                        lat, lon, properties: { name, direccion }
                                    });
                                }
                            });

                            layerGroups[name] = { layer: layerGroup, markers };
                            if (visible) {
                                layerGroup.addTo(map);
                                activeLayer = { name, markers };
                            }
                        }
                    });
                });
        }

        // Agregar capas
        for (const [name, url] of Object.entries(urls)) {
            addLayer(name, url, name === "Consolidado");
        }

        // Controlador de capas
        const layersControl = L.control.layers(null, null, { collapsed: false }).addTo(map);
        Object.keys(urls).forEach(name => {
            layersControl.addOverlay(layerGroups[name]?.layer, name);
        });

        // Listener para cambios de capa activa
        map.on('overlayadd', e => {
            const name = e.name;
            activeLayer = layerGroups[name];
        });

        map.on('overlayremove', e => {
            if (activeLayer?.name === e.name) {
                activeLayer = null;
            }
        });

        // Función para descargar GeoJSON
        document.getElementById('geojsonButton').addEventListener('click', () => {
            if (!activeLayer) {
                alert("No hay una capa activa.");
                return;
            }

            const geojson = {
                type: "FeatureCollection",
                features: activeLayer.markers.map(marker => ({
                    type: "Feature",
                    properties: marker.properties,
                    geometry: {
                        type: "Point",
                        coordinates: [marker.lon, marker.lat]
                    }
                }))
            };

            const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: "application/json" });
            saveAs(blob, `${activeLayer.name}.geojson`);
        });

        // Función para descargar KMZ
        document.getElementById('kmzButton').addEventListener('click', () => {
            if (!activeLayer) {
                alert("No hay una capa activa.");
                return;
            }

            const geojson = {
                type: "FeatureCollection",
                features: activeLayer.markers.map(marker => ({
                    type: "Feature",
                    properties: marker.properties,
                    geometry: {
                        type: "Point",
                        coordinates: [marker.lon, marker.lat]
                    }
                }))
            };

            const kml = tokml(geojson);
            const zip = new JSZip();
            zip.file("doc.kml", kml);
            zip.generateAsync({ type: "blob" }).then(content => {
                saveAs(content, `${activeLayer.name}.kmz`);
            });
        });
    </script>
</body>
</html>
