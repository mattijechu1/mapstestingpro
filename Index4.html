<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terrazas Providencia</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tokml@0.4.0/tokml.min.js"></script>
    <style>
        #map { height: 600px; width: 100%; }
        .download-button { margin-top: 10px; display: block; text-align: center; }
    </style>
</head>
<body>
    <h1>Terrazas Gastronómicas Providencia</h1>
    <div id="map"></div>
    <button id="kmzButton" class="download-button">Descargar KMZ</button>
    <button id="geojsonButton" class="download-button">Descargar GeoJSON</button>
    <script>
        // Inicializar el mapa
        const map = L.map('map').setView([-33.433333, -70.616667], 14.4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let markers = [];
        const htmlUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKCCPRxUwaXo-LXGeUQgZSCzVWZdIYiHNiY51_-u4AG0yODEfv4qd_ErKxQ-6RuQ/pubhtml';

        // Obtener la tabla HTML de Google Sheets
        fetch(htmlUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const table = doc.querySelector('table'); // Seleccionar la tabla
                if (!table) {
                    console.error('No se encontró una tabla en el documento HTML.');
                    return;
                }

                // Extraer filas de la tabla
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 4) {
                        const lat = parseFloat(cells[0].innerText); // Primera columna para la latitud
                        const lon = parseFloat(cells[1].innerText); // Segunda columna para la longitud
                        const name = cells[2].innerText || `Punto ${index + 1}`;
                        const direccion = cells[3].innerText || 'Dirección no disponible';

                        // Validar coordenadas
                        if (!isNaN(lat) && !isNaN(lon)) {
                            // Crear marcador
                            const circle = L.circleMarker([lat, lon], {
                                color: 'blue',
                                radius: 4,
                                fillOpacity: 0.8,
                                weight: 0
                            }).addTo(map).bindPopup(`<strong>${name}</strong><br>Dirección: ${direccion}`);
                            markers.push({
                                lat: lat,
                                lon: lon,
                                properties: { name, direccion }
                            });
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error al procesar el HTML:', error);
            });

        // Función para convertir a KMZ
        document.getElementById('kmzButton').addEventListener('click', function() {
            const geojson = {
                type: "FeatureCollection",
                features: markers.map(marker => ({
                    type: "Feature",
                    properties: marker.properties,
                    geometry: {
                        type: "Point",
                        coordinates: [marker.lon, marker.lat]
                    }
                }))
            };

            const kml = tokml(geojson);
            const zip = new JSZip();
            zip.file("doc.kml", kml);
            zip.generateAsync({ type: "blob" }).then(function(content) {
                saveAs(content, "terrazas_providencia.kmz");
            });
        });

        // Función para descargar GeoJSON
        document.getElementById('geojsonButton').addEventListener('click', function() {
            const geojson = {
                type: "FeatureCollection",
                features: markers.map(marker => ({
                    type: "Feature",
                    properties: marker.properties,
                    geometry: {
                        type: "Point",
                        coordinates: [marker.lon, marker.lat]
                    }
                }))
            };

            const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: "application/json" });
            saveAs(blob, "terrazas_providencia.geojson");
        });
    </script>
</body>
</html>
