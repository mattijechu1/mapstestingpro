<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thematic Layer Selector</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
        }
        #menu {
            width: 220px;
            padding: 10px;
            background: #f4f4f4;
            border-right: 1px solid #ddd;
        }
        #map {
            flex: 1;
            height: 100vh;
        }
        select {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <div id="menu">
        <h2>Temáticas</h2>
        <select id="thematicSelector"></select>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        const thematicSelector = document.getElementById('thematicSelector');
        const map = L.map('map').setView([-33.4312, -70.6422], 13);
        const layerControl = L.control.layers().addTo(map);

        // Add base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // URL of thematic data CSV
        const thematicCsvUrl = "https://docs.google.com/spreadsheets/d/1wXxDx_bVRiCqbW67DdD5e_487gNA_DjhMA3z7XT0m10/pub?gid=1082644547&single=true&output=csv";

        let thematicData = {};

        async function loadThematicData() {
            const response = await fetch(thematicCsvUrl);
            const text = await response.text();
            const parsedData = Papa.parse(text, { header: true }).data;

            // Process data into thematic structure
            parsedData.forEach(row => {
                const { ID, Temática, Cobertura, "Activo por defecto": activo, URL } = row;

                if (!thematicData[Temática]) {
                    thematicData[Temática] = [];
                }

                thematicData[Temática].push({
                    cobertura: Cobertura,
                    activo: activo.trim().toLowerCase() === 'sí',
                    url: URL
                });
            });

            populateThematicSelector();
        }

        function populateThematicSelector() {
            thematicSelector.innerHTML = '';

            Object.keys(thematicData).forEach(thematic => {
                const option = document.createElement('option');
                option.value = thematic;
                option.textContent = thematic;
                thematicSelector.appendChild(option);
            });

            // Load first thematic by default
            if (thematicSelector.options.length > 0) {
                loadCoverageLayers(thematicSelector.value);
            }
        }

        async function loadCoverageLayers(thematic) {
            layerControl.clearLayers();

            const coverages = thematicData[thematic];
            for (const coverage of coverages) {
                try {
                    const response = await fetch(coverage.url);
                    const text = await response.text();
                    const data = Papa.parse(text, { header: false }).data;

                    const geojsonString = data[1][0]; // A2: GeoJSON string
                    const geojson = JSON.parse(geojsonString);

                    const layer = L.geoJSON(geojson, {
                        onEachFeature: (feature, layer) => {
                            let popupContent = '';
                            for (const key in feature.properties) {
                                if (feature.properties.hasOwnProperty(key)) {
                                    popupContent += `${key}: ${feature.properties[key]}<br>`;
                                }
                            }
                            layer.bindPopup(popupContent);
                        }
                    });

                    layerControl.addOverlay(layer, coverage.cobertura);

                    if (coverage.activo) {
                        layer.addTo(map);
                    }
                } catch (error) {
                    console.error(`Error loading coverage ${coverage.cobertura}:`, error);
                }
            }
        }

        thematicSelector.addEventListener('change', (event) => {
            loadCoverageLayers(event.target.value);
        });

        loadThematicData();
    </script>
</body>
</html>
