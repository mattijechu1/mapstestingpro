<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terrazas Providencia</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tokml@0.4.0/tokml.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <style>
        #map { height: 600px; width: 100%; }
        .download-button { margin-top: 10px; display: block; text-align: center; }
        .layer-control { margin-top: 10px; }
    </style>

<style>
    body {
        text-align: center; 
    }

    h1 {
        text-align: center; 
    }

    .download-button {
        display: inline-block; 
        margin-top: 10px; 
        text-align: center; 
        padding: 10px 20px; 
        background-color: #007BFF; 
        color: white; 
        border: none; 
        border-radius: 5px; 
        cursor: pointer; 
    }

    .download-button:hover {
        background-color: #0056b3; 
    }

    .leaflet-control-layers-list {
        text-align: left; 
    }

    #map {
        height: 600px;
        width: 100%;
        margin-top: 20px; 
    }
</style>   
</head>
<body>
    <h1>Terrazas Gastronómicas Providencia</h1>
    <div id="map"></div>
    <button id="kmzButton" class="download-button">Descargar KMZ</button>
    <button id="geojsonButton" class="download-button">Descargar GeoJSON</button>
  <script>
    const map = L.map('map').setView([-33.433333, -70.616667], 14.4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    const geocoder = L.Control.geocoder({
        defaultMarkGeocode: false
    })
        .on('markgeocode', function(e) {
            const bbox = e.geocode.bbox;
            const poly = L.polygon([
                [bbox.getSouthEast().lat, bbox.getSouthEast().lng],
                [bbox.getNorthEast().lat, bbox.getNorthEast().lng],
                [bbox.getNorthWest().lat, bbox.getNorthWest().lng],
                [bbox.getSouthWest().lat, bbox.getSouthWest().lng]
            ]);
            map.fitBounds(poly.getBounds());
            L.marker(e.geocode.center).addTo(map).bindPopup(e.geocode.name).openPopup();
        })
        .addTo(map);

    const geocoderContainer = geocoder.getContainer();
    const zoomControl = document.querySelector('.leaflet-control-zoom');
    zoomControl.parentNode.insertBefore(geocoderContainer, zoomControl);

    const csvUrls = {
        Consolidado: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQQwiNO1dZQg78m4X9fRe6MTZWioBXd0kJuUEKMZGwCZx9ZrhA5de20VDaHr5ySVQ/pub?gid=895076813&single=true&output=csv',
        Rentas: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQQwiNO1dZQg78m4X9fRe6MTZWioBXd0kJuUEKMZGwCZx9ZrhA5de20VDaHr5ySVQ/pub?gid=2142198563&single=true&output=csv',
        Fiscalización: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQQwiNO1dZQg78m4X9fRe6MTZWioBXd0kJuUEKMZGwCZx9ZrhA5de20VDaHr5ySVQ/pub?gid=824072282&single=true&output=csv',
        Levantamiento_2024: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQQwiNO1dZQg78m4X9fRe6MTZWioBXd0kJuUEKMZGwCZx9ZrhA5de20VDaHr5ySVQ/pub?gid=407831942&single=true&output=csv',
        'DIDEL 2023': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQQwiNO1dZQg78m4X9fRe6MTZWioBXd0kJuUEKMZGwCZx9ZrhA5de20VDaHr5ySVQ/pub?gid=950109891&single=true&output=csv'
    };

    const layers = {};
    const markers = {};

    function loadCsv(url, groupName) {
        return fetch(url)
            .then(response => response.text())
            .then(data => {
                Papa.parse(data, {
                    header: true,
                    complete: function(results) {
                        const data = results.data;
                        if (!data.length) {
                            console.error(`El archivo CSV de ${groupName} está vacío.`);
                            return;
                        }

                        data.forEach((row, index) => {
                            const lat = parseFloat(row.Y);
                            const lon = parseFloat(row.X);
                            const name = row.LOCAL || `Punto ${index + 1}`;
                            const direccion = row.DIRECCIÓN || 'Dirección no disponible';
                            const local = row.LOCAL || 'No aplica';
                            const razon = row.RAZON_SOCIAL||'';
                            const patente = row.PATENTE ||'';
                            const nombre = row.NOMBRE ||'';
                            const rol = row.ROL ||'';
                            const rut = row.RUT_EMPRESA ||'';
                            const razonr = row.Razón_Social ||'';
                            const actividades = row.Actividades ||'';
                            const fecha = row.Fecha_Inicio_Negocio ||'';
                            const telefono = row.Teléfono_Contribuyente ||'';
                            const correo = row.Correo_Negocio ||'';	
                            const MT2BNUP = row.MTS2_BNUP ||'';
                            const foto = row.FOTO ||'';

                            if (!isNaN(lat) && !isNaN(lon)) {
                                const popupContent = 
                                    `<strong>${name}</strong><br>
                                    Dirección: ${direccion}<br>
                                    Local: ${local}<br>
                                    Lat: ${lat}, Lon: ${lon}<br>
                                    Razon: ${razon}<br>
                                    Patente: ${patente}<br>
                                    Nombre: ${nombre}<br>
                                    Rol: ${rol}<br>
                                    Rut: ${rut}<br>
                                    Razon social: ${razonr}<br>
                                    Actividades: ${actividades}<br>
                                    Fecha: ${fecha}<br>
                                    Teléfono: ${telefono}<br>
                                    Correo:${correo}<br>
                                    Metros cuadrados BNUP: ${MT2BNUP}<br>
                                    ${foto ? `<br><img src="${foto}" style="width:200px; height:auto;">` : ''}`;
                                const circle = L.circleMarker([lat, lon], {
                                    color: 'blue',
                                    radius: 4,
                                    fillOpacity: 0.8,
                                    weight: 0
                                }).bindPopup(popupContent);
                                layers[groupName].addLayer(circle);

                                if (!markers[groupName]) {
                                    markers[groupName] = [];
                                }
                                markers[groupName].push({
                                    lat,
                                    lon,
                                    properties: { name, direccion, local, razon, patente, nombre, rol, rut, razonr, actividades, fecha, telefono, correo, MT2BNUP, foto}
                                });
                            }
                        });
                    }
                });
            });
    }

    Object.keys(csvUrls).forEach(groupName => {
        layers[groupName] = L.layerGroup();
        loadCsv(csvUrls[groupName], groupName);
    });

    layers['Consolidado'].addTo(map);

    const layerControl = L.control.layers(null, layers).addTo(map);

    function downloadData(type) {
        const activeLayer = Object.keys(layers).find(groupName => map.hasLayer(layers[groupName]));
        if (!activeLayer) {
            alert('Por favor, activa una capa para descargar.');
            return;
        }

        const geojson = {
            type: 'FeatureCollection',
            features: markers[activeLayer].map(marker => ({
                type: 'Feature',
                properties: marker.properties,
                geometry: {
                    type: 'Point',
                    coordinates: [marker.lon, marker.lat]
                }
            }))
        };

        if (type === 'KMZ') {
            const kml = tokml(geojson);
            const zip = new JSZip();
            zip.file('doc.kml', kml);
            zip.generateAsync({ type: 'blob' }).then(content => {
                saveAs(content, `${activeLayer}.kmz`);
            });
        } else if (type === 'GeoJSON') {
            const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: 'application/json' });
            saveAs(blob, `${activeLayer}.geojson`);
        }
    }
    document.getElementById('kmzButton').addEventListener('click', () => downloadData('KMZ'));
    document.getElementById('geojsonButton').addEventListener('click', () => downloadData('GeoJSON'));
  </script>
</body>
</html>
